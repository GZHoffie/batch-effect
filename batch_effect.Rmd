---
title: "Metric for Batch Effects"
output: html.document
date: "2022-10-28"
---

```{r setup, include=FALSE}
library(MASS)
library(kBET)
library(ggplot2)
```

We first set some hyper-parameters (mean and variance) for different cell types.

```{r}
cell.a.mu <- c(-3, 0)
cell.a.sigma <- matrix(c(1, 0, 0, 1), 2, 2)

cell.b.mu <- c(3, 0)
cell.b.sigma <- matrix(c(1, 0, 0, 1), 2, 2)
```

And we also create random distributions for batch effects for different batches. The batch effects are set to be smaller than biological variance.

```{r}
# Distribution of batch effects
be.1.mu <- c(0, 5)
be.1.sigma <- matrix(c(2, 0, 0, 2), 2, 2)


be.2.mu <- c(0, -5)
be.2.sigma <- matrix(c(0.5, 0, 0, 0.5), 2, 2)
```

Now, we can start creating data for batches.

```{r}
num.cells <- 1000
batch.1.composition <- ceiling(c(0.6, 0.4) * num.cells)
batch.2.composition <- ceiling(c(0.4, 0.6) * num.cells)

# data for different batch, without batch effect
batch.1 <- rbind(mvrnorm(n = batch.1.composition[1], cell.a.mu, cell.a.sigma),
                 mvrnorm(n = batch.1.composition[2], cell.b.mu,  cell.b.sigma))
batch.1 <- data.frame(batch.1)
batch.1$cell.type <- c(rep(4, batch.1.composition[1]), rep(1, batch.1.composition[2]))
batch.1$batch <- 'A'

batch.2 <- rbind(mvrnorm(n = batch.2.composition[1], cell.a.mu, cell.a.sigma),
                 mvrnorm(n = batch.2.composition[2], cell.b.mu,  cell.b.sigma))
batch.2 <- data.frame(batch.2)
batch.2$cell.type <- c(rep(4, batch.2.composition[1]), rep(1, batch.2.composition[2]))
batch.2$batch <- 'B'

# data with batch effect
batch.1.be <- batch.1[c("X1", "X2")] + mvrnorm(n = nrow(batch.1), be.1.mu, be.1.sigma)
batch.1.be[c("cell.type", "batch")] <- batch.1[c("cell.type", "batch")]
batch.2.be <- batch.2[c("X1", "X2")] + mvrnorm(n = nrow(batch.2), be.2.mu, be.2.sigma)
batch.2.be[c("cell.type", "batch")] <- batch.2[c("cell.type", "batch")]
```


We can plot out the batches,

```{r}
# function for plotting batches out
plot_batches <- function(batch.1.df, batch.2.df, title) {
  plot(batch.1.df$X2 ~ batch.1.df$X1, 
       xlab = "PC1", 
       ylab = "PC2", 
       pch = batch.1.df$cell.type, 
       col = "blue", 
       xlim = c(min(batch.1.df$X1, batch.2.df$X1), max(batch.1.df$X1, batch.2.df$X1)+3), 
       ylim = c(min(batch.1.df$X2, batch.2.df$X2)-1, max(batch.1.df$X2, batch.2.df$X2)+1),
       main = title)
  points(batch.2.df$X2 ~ batch.2.df$X1, 
         pch=batch.2.df$cell.type, 
         col="red")
  legend("bottomright", 
         title = "cell type", 
         legend = c("A", "B"), 
         pch = c(4, 1))
  legend("topright", 
         title = "batch", 
         legend = c("1", "2"), 
         pch = c(15, 15), 
         col = c("red", "blue"))
}
plot_batches(batch.1, batch.2, "Batches without batch effect")
```

```{r}
plot_batches(batch.1.be, batch.2.be, "Batches with batch effect")
```

Now we can try using kBET on the dataset,

```{r}
data <- rbind(batch.1[c("X1", "X2")], batch.2[c("X1", "X2")])
data.batch <- c(batch.1$batch, batch.2$batch)
#res <- kBET(data, data.batch)
```

And for data with batch effect,

```{r}
data.be <- rbind(batch.1.be[c("X1", "X2")], batch.2.be[c("X1", "X2")])
data.be.batch <- c(batch.1.be$batch, batch.2.be$batch)
#res.be <- kBET(data.be, data.be.batch)
```



```{r}
data$batch = data.batch
ggplot(data, aes(X1, fill = batch)) + geom_density(alpha = 0.2)
```


```{r}
data.be$batch = data.batch
ggplot(data.be, aes(X2, fill = batch)) + geom_density(alpha = 0.2)
```